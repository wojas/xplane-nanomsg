syntax = "proto3";

package xplane;

// The Header is a required part of the request and will be
// returned in the response.
message Header {
    // Globally unique session ID for the client. Any longer lasting
    // resources are tied to this session and destroyed after
    // ttl_seconds if the client stops sending us messages.
    // This ID is generated by the client. A UUID is recommended.
    // Session IDs SHOULD NOT be reused between client runs.
    string session_id = 1;
    // Optional message ID that the client can use to keep track of
    // requests and their responses.
    uint64 msg_id = 2;
}


message SessionOptions {
    // Seconds to keep the session alive without keepalive
    // TODO: How to deal with pauses and suspends?
    int32 ttl_seconds = 1;
    // For error messages and debugging
    string client_name = 2;
    // If only a single session is allowed for the app.
    // Any previous session with this id will be terminated.
    string unique_app_id = 3;
}

message PositionOptions {
    double lat = 1;
    double lon = 2;

    // Set one of these
    double elev = 3; // meters
    double alt = 4;  // feet
    // TODO: Can we support y_agl in some way?
    //       When is sim/flightmodel/ground/plugin_ground_center updated?
    double y_agl = 5; // TODO: experiment, remove if it does not work
}

message Request {
    enum Command {
        UnknownCommand = 0;
        CreateSession = 1;
        CloseSession = 2;
        GetPosition = 3;
        SubscribePosition = 4;
        SetPosition = 5;
        GetDataRefs = 6;
        SetDataRefs = 7;
        SubscribeData = 8;
        SetSubscribedData = 9;
        CreateInstance = 10;
        DestroyInstance = 11;
        InstanceSetPosition = 12;
        GetStats = 13;
    }

    Header header = 1;
    Command command = 3;

    PositionOptions position = 5;
}

message Response {
    Header header = 1;
    bool success = 2;
    string error = 3;

    Stats stats = 10;
}

message Box {
    int32 left = 1;
    int32 top = 2;
    int32 right = 3;
    int32 bottom = 4;
    // Used for the monitor ID
    int32 id = 5;
}

message Info {
    int32 plugin_id = 1;
    int64 start_time_unix = 2;

    Box screen_bounds = 10;
    repeated Box monitor_bounds = 11;
}

message Stats {
    // Time our handler took in microseconds during the previous run
    int32 handler_time_usec = 1;
    uint32 total_publish_errors = 2;
    int32 last_publish_error_code = 3;
    float elapsed_since_last_call = 4; // seconds
    float elapsed_time_since_last_flight_loop = 5; // seconds
    int32 flight_loop_counter = 6;
    int32 command_parse_errors = 7;
    int32 command_receives = 8;
    uint32 total_command_errors = 9;
    int32 last_command_error_code = 10;
}

message PluginMessage {
    int32 plugin_id = 1;
    int32 msg_id = 2;
    uint64 param = 3; // The inParam pointer value
    // TODO: Perhaps add name of sending plugin
}

message DataRef {
    // See XPLMDataTypeID: https://developer.x-plane.com/sdk/XPLMDataAccess/
    enum Type {
        Unknown = 0;
        Int = 1;
        Float = 2;
        Double = 4;
        FloatArray = 8;
        IntArray = 16;
        Data = 32;
    }

    string name = 1;
    // TODO: How do we want to deal with multiple possible values
    Type ref_type = 2;
    uint32 all_types = 22; // bitmask of all supported types, optional

    int32 int_val = 3;
    float float_val = 4;
    double double_val = 5;
    bytes data_val = 6;
    repeated int32 int_array = 7;
    repeated float float_array = 8;

    bool can_write = 9;

    // For arrays
    int32 offset = 10;
    int32 count = 11;
}

message Position {
    // TODO: double like in XPLMWorldToLocal
    // TODO: Notify when the local coordinates have changed?
    double x = 1;
    double y = 2;
    double z = 3;
    float pitch = 4;
    float heading = 5;
    float roll = 6;
    double lat = 7;
    double lon = 8;
    float y_agl = 9;
    float vx = 10;
    float vy = 11;
    float vz = 12;
    float gs = 13;
    float ias = 14;
    float ias2 = 15;
    float tas = 16;
    float vh_ind = 17;
    float vh_ind_fpm = 18;
    float vh_ind_fpm2 = 19;
    float p = 20;
    float q = 21;
    float r = 22;

    double elev = 31;
    double alt = 32;
    float true_pitch = 33;
    float true_heading = 34;
    float true_roll = 35;
    float mag_heading = 36;
    float lat_ref = 37;
    float lon_ref = 38;
}

// Message is used for pubsub broadcasts
message Message {
    enum Type {
        Unknown = 0;
        Stats = 10;
        Info = 11;
        PluginMessage = 12;
        RPC = 13;
        Position = 14;
    }

    Type msg_type = 1;

    //
    // Which of these are set depends on the message type
    //

    Stats stats = 10;
    Info info = 11;
    PluginMessage plugin_message = 12;
    // If enabled, all requests and responses will be broadcast to the 'rpc' channel for debugging.
    Request rpc = 13;
    Position position = 14;
}
